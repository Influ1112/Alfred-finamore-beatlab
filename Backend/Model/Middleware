import jwt from "jsonwebtoken";

const JWT_SECRET = process.env.JWT_SECRET;
if (!JWT_SECRET) {
  console.warn("Missing JWT_SECRET env var â€” auth will be permissive in dev");
}

/**
 * authOptional - if Authorization header present, verify and set req.user.
 * If missing or invalid, continue without user.
 */
export async function authOptional(req, res, next) {
  const auth = req.headers.authorization;
  if (!auth) return next();

  const parts = auth.split(" ");
  if (parts.length !== 2 || parts[0] !== "Bearer") {
    return next();
  }

  try {
    const payload = jwt.verify(parts[1], JWT_SECRET);
    req.user = payload;
  } catch (err) {
    console.warn("Invalid JWT token:", err.message || err);
  }
  return next();
}

/**
 * authRequired - require a valid bearer token and set req.user.
 * Returns 401 if missing/invalid.
 */
export async function authRequired(req, res, next) {
  const auth = req.headers.authorization;
  if (!auth) {
    return res.status(401).json({ error: "Missing Authorization header" });
  }

  const parts = auth.split(" ");
  if (parts.length !== 2 || parts[0] !== "Bearer") {
    return res.status(401).json({ error: "Malformed Authorization header" });
  }

  try {
    const payload = jwt.verify(parts[1], JWT_SECRET);
    req.user = payload;
    return next();
  } catch (err) {
    return res.status(401).json({ error: "Invalid token" });
  }
}
